{% extends "base.html" %}

{% block title %}Todos os Candidatos{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-xl flex items-center justify-center">
                        <span class="text-white font-bold text-lg">üë•</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">
                            Banco de Candidatos
                        </h1>
                        <p class="text-gray-500 text-sm">Explore todos os candidatos cadastrados na plataforma</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <a href="{{ url_for('candidatos_favoritos') }}" 
                       class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-xl transition-all duration-300 flex items-center gap-2">
                        <span>‚≠ê</span>
                        Favoritos
                    </a>
                    <a href="{{ url_for('dashboard_empresa') }}" 
                       class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-xl transition-all duration-300 flex items-center gap-2">
                        <span>‚¨ÖÔ∏è</span>
                        Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                        <span class="text-2xl">üë•</span>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Total de Candidatos</p>
                        <p id="totalCandidatos" class="text-2xl font-bold text-blue-600">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                        <span class="text-2xl">üìã</span>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Com Curr√≠culo</p>
                        <p id="comCurriculo" class="text-2xl font-bold text-green-600">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center">
                        <span class="text-2xl">‚≠ê</span>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Favoritados</p>
                        <p id="totalFavoritados" class="text-2xl font-bold text-yellow-600">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-8">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Filtros de Busca</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Busca por nome/email -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Buscar por nome ou email</label>
                    <input type="text" 
                           id="searchInput" 
                           placeholder="Digite nome ou email..."
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Faixa salarial -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pretens√£o Salarial</label>
                    <select id="salarioFilter" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todas as faixas</option>
                        <option value="0-2000">At√© R$ 2.000</option>
                        <option value="2000-5000">R$ 2.000 - R$ 5.000</option>
                        <option value="5000-8000">R$ 5.000 - R$ 8.000</option>
                        <option value="8000-12000">R$ 8.000 - R$ 12.000</option>
                        <option value="12000-999999">Acima de R$ 12.000</option>
                    </select>
                </div>

                <!-- Localiza√ß√£o -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Localiza√ß√£o</label>
                    <input type="text" 
                           id="locationFilter" 
                           placeholder="Cidade, Estado..."
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Compet√™ncias -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Compet√™ncias</label>
                    <input type="text" 
                           id="skillsFilter" 
                           placeholder="Ex: Python, React, Marketing..."
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div class="flex gap-3 mt-4">
                <button onclick="aplicarFiltros()" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300">
                    üîç Buscar
                </button>
                <button onclick="limparFiltros()" 
                        class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300">
                    üîÑ Limpar
                </button>
            </div>
        </div>

        <!-- Lista de candidatos -->
        <div id="candidatosList">
            <div class="text-center py-8">
                <div class="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                <p class="text-gray-500">Carregando candidatos...</p>
            </div>
        </div>

        <!-- Pagina√ß√£o -->
        <div id="paginacao" class="flex justify-center mt-8 hidden">
            <div class="flex gap-2">
                <button onclick="anteriorPagina()" 
                        id="btnAnterior"
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all duration-300 disabled:opacity-50">
                    ‚Üê Anterior
                </button>
                <span id="infoPagina" class="px-4 py-2 text-gray-700"></span>
                <button onclick="proximaPagina()" 
                        id="btnProximo"
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all duration-300 disabled:opacity-50">
                    Pr√≥ximo ‚Üí
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let todosCandidatos = [];
let candidatosFiltrados = [];
let paginaAtual = 1;
const candidatosPorPagina = 12;

// Carregar todos os candidatos
async function carregarCandidatos() {
    try {
        const response = await fetch('/api/candidatos-geral');
        if (!response.ok) throw new Error('Erro na requisi√ß√£o');

        todosCandidatos = await response.json();
        candidatosFiltrados = [...todosCandidatos];

        atualizarEstatisticas();
        renderizarCandidatos();

    } catch (error) {
        console.error('Erro ao carregar candidatos:', error);
        document.getElementById('candidatosList').innerHTML = `
            <div class="text-center py-12 bg-white rounded-2xl shadow-sm border border-gray-100">
                <div class="w-24 h-24 bg-red-100 rounded-full mx-auto mb-6 flex items-center justify-center">
                    <span class="text-4xl">‚ùå</span>
                </div>
                <h3 class="text-xl font-bold text-gray-600 mb-3">Erro ao carregar candidatos</h3>
                <p class="text-gray-500">Tente recarregar a p√°gina.</p>
            </div>
        `;
    }
}

// Atualizar estat√≠sticas
function atualizarEstatisticas() {
    document.getElementById('totalCandidatos').textContent = todosCandidatos.length;
    document.getElementById('comCurriculo').textContent = todosCandidatos.filter(c => c.tem_curriculo).length;
    document.getElementById('totalFavoritados').textContent = todosCandidatos.filter(c => c.is_favorito).length;
}

// Aplicar filtros
function aplicarFiltros() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const salarioRange = document.getElementById('salarioFilter').value;
    const location = document.getElementById('locationFilter').value.toLowerCase();
    const skills = document.getElementById('skillsFilter').value.toLowerCase();

    candidatosFiltrados = todosCandidatos.filter(candidato => {
        // Filtro de busca por nome/email
        const matchSearch = !searchTerm || 
            candidato.nome.toLowerCase().includes(searchTerm) ||
            candidato.email.toLowerCase().includes(searchTerm);

        // Filtro de sal√°rio
        let matchSalario = true;
        if (salarioRange) {
            const [min, max] = salarioRange.split('-').map(Number);
            const salario = candidato.pretensao_salarial || 0;
            matchSalario = salario >= min && salario <= max;
        }

        // Filtro de localiza√ß√£o
        const matchLocation = !location || 
            candidato.endereco_completo.toLowerCase().includes(location);

        // Filtro de compet√™ncias
        const matchSkills = !skills || 
            (candidato.competencias && candidato.competencias.toLowerCase().includes(skills)) ||
            (candidato.texto_curriculo && candidato.texto_curriculo.toLowerCase().includes(skills));

        return matchSearch && matchSalario && matchLocation && matchSkills;
    });

    paginaAtual = 1;
    renderizarCandidatos();
}

// Limpar filtros
function limparFiltros() {
    document.getElementById('searchInput').value = '';
    document.getElementById('salarioFilter').value = '';
    document.getElementById('locationFilter').value = '';
    document.getElementById('skillsFilter').value = '';
    
    candidatosFiltrados = [...todosCandidatos];
    paginaAtual = 1;
    renderizarCandidatos();
}

// Renderizar candidatos com pagina√ß√£o
function renderizarCandidatos() {
    const container = document.getElementById('candidatosList');
    const inicio = (paginaAtual - 1) * candidatosPorPagina;
    const fim = inicio + candidatosPorPagina;
    const candidatosPagina = candidatosFiltrados.slice(inicio, fim);

    if (candidatosFiltrados.length === 0) {
        container.innerHTML = `
            <div class="text-center py-12 bg-white rounded-2xl shadow-sm border border-gray-100">
                <div class="w-24 h-24 bg-gray-100 rounded-full mx-auto mb-6 flex items-center justify-center">
                    <span class="text-4xl">üîç</span>
                </div>
                <h3 class="text-xl font-bold text-gray-600 mb-3">Nenhum candidato encontrado</h3>
                <p class="text-gray-500 mb-6">Tente ajustar os filtros de busca.</p>
                <button onclick="limparFiltros()" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300">
                    Limpar Filtros
                </button>
            </div>
        `;
        document.getElementById('paginacao').classList.add('hidden');
        return;
    }

    let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';

    candidatosPagina.forEach(candidato => {
        const salarioFormatado = candidato.pretensao_salarial ? 
            new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(candidato.pretensao_salarial) : 
            'N√£o informado';

        html += `
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 hover:shadow-lg hover:border-blue-200 transition-all duration-300">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-100 to-indigo-100 rounded-xl flex items-center justify-center">
                            <span class="text-2xl">üë§</span>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">${candidato.nome}</h3>
                            <p class="text-sm text-gray-500">${candidato.email}</p>
                        </div>
                    </div>
                    <button onclick="toggleFavorito(${candidato.id}, this)"
                            data-favorito="${candidato.is_favorito}"
                            class="favorite-btn text-xl transition-all duration-300 hover:scale-125 ${candidato.is_favorito ? 'text-yellow-500' : 'text-gray-300'}">
                        ${candidato.is_favorito ? '‚≠ê' : '‚òÜ'}
                    </button>
                </div>

                <div class="space-y-3">
                    <div class="flex items-center gap-2">
                        <span class="text-green-600">üí∞</span>
                        <span class="text-sm text-gray-700">Pretens√£o: ${salarioFormatado}</span>
                    </div>

                    ${candidato.telefone ? `
                        <div class="flex items-center gap-2">
                            <span class="text-blue-600">üì±</span>
                            <span class="text-sm text-gray-700">${candidato.telefone}</span>
                        </div>
                    ` : ''}

                    ${candidato.endereco_completo ? `
                        <div class="flex items-center gap-2">
                            <span class="text-purple-600">üìç</span>
                            <span class="text-sm text-gray-700">${candidato.endereco_completo}</span>
                        </div>
                    ` : ''}

                    ${candidato.competencias ? `
                        <div class="mt-3">
                            <p class="text-xs text-gray-500 mb-1">Compet√™ncias:</p>
                            <p class="text-sm text-gray-700 line-clamp-2">${candidato.competencias}</p>
                        </div>
                    ` : ''}
                </div>

                <div class="flex gap-2 mt-4">
                    ${candidato.tem_curriculo ? `
                        <a href="/baixar_curriculo/${candidato.id}" 
                           class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-xl text-sm font-semibold text-center transition-all duration-300">
                            üìÑ Curr√≠culo
                        </a>
                    ` : `
                        <div class="flex-1 bg-gray-200 text-gray-500 px-3 py-2 rounded-xl text-sm text-center">
                            Sem curr√≠culo
                        </div>
                    `}

                    ${candidato.linkedin ? `
                        <a href="${candidato.linkedin}" target="_blank"
                           class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-xl text-sm font-semibold transition-all duration-300">
                            üîó
                        </a>
                    ` : ''}
                </div>
            </div>
        `;
    });

    html += '</div>';
    container.innerHTML = html;

    // Atualizar pagina√ß√£o
    atualizarPaginacao();
}

// Atualizar pagina√ß√£o
function atualizarPaginacao() {
    const totalPaginas = Math.ceil(candidatosFiltrados.length / candidatosPorPagina);
    
    if (totalPaginas <= 1) {
        document.getElementById('paginacao').classList.add('hidden');
        return; 
    }

    document.getElementById('paginacao').classList.remove('hidden');
    document.getElementById('infoPagina').textContent = `P√°gina ${paginaAtual} de ${totalPaginas}`;
    
    document.getElementById('btnAnterior').disabled = paginaAtual === 1;
    document.getElementById('btnProximo').disabled = paginaAtual === totalPaginas;
}

// Navega√ß√£o de p√°ginas
function anteriorPagina() {
    if (paginaAtual > 1) {
        paginaAtual--;
        renderizarCandidatos();
    }
}

function proximaPagina() {
    const totalPaginas = Math.ceil(candidatosFiltrados.length / candidatosPorPagina);
    if (paginaAtual < totalPaginas) {
        paginaAtual++;
        renderizarCandidatos();
    }
}

// Toggle favorito
async function toggleFavorito(candidatoId, button) {
    const isFavorito = button.dataset.favorito === 'true';

    try {
        button.classList.add('animate-pulse');

        const response = await fetch('/api/favoritar-candidato-geral', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                candidato_id: candidatoId,
                acao: 'toggle'
            })
        });

        const result = await response.json();

        if (result.success) {
            button.dataset.favorito = result.favorited;
            button.textContent = result.favorited ? '‚≠ê' : '‚òÜ';
            button.className = `favorite-btn text-xl transition-all duration-300 hover:scale-125 ${result.favorited ? 'text-yellow-500' : 'text-gray-300'}`;

            // Atualizar na lista local
            const candidato = todosCandidatos.find(c => c.id === candidatoId);
            if (candidato) {
                candidato.is_favorito = result.favorited;
            }

            atualizarEstatisticas();
            showToast(result.message, 'success');
        } else {
            showToast(result.message || 'Erro ao favoritar candidato', 'error');
        }
    } catch (error) {
        console.error('Erro ao favoritar:', error);
        showToast('Erro ao favoritar candidato', 'error');
    } finally {
        button.classList.remove('animate-pulse');
    }
}

// Toast notifications
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 z-50 px-6 py-4 rounded-xl shadow-lg transform translate-y-full transition-all duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    toast.textContent = message;

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.classList.remove('translate-y-full');
    }, 100);

    setTimeout(() => {
        toast.classList.add('translate-y-full');
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}

// Busca em tempo real
document.getElementById('searchInput').addEventListener('input', function() {
    aplicarFiltros();
});

// Carregar candidatos quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    carregarCandidatos();
});
</script>
{% endblock %}
