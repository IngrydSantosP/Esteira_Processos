{% extends "base.html" %}

{% block title %}Candidatos da Vaga{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-xl flex items-center justify-center">
                        <span class="text-white font-bold text-lg">üë•</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                            Candidatos - {{ vaga_titulo }}
                        </h1>
                        <p class="text-gray-500 text-sm">Gerencie e analise os candidatos desta vaga</p>
                    </div>
                </div>
                <a href="{{ url_for('dashboard_empresa') }}" 
                   class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-xl transition-all duration-300 flex items-center gap-2">
                    <span>‚¨ÖÔ∏è</span>
                    Voltar ao Dashboard
                </a>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Filtros de Busca -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-8">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span>üîç</span>
                Filtros de Busca
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Candidato</label>
                    <input type="text" id="searchName" placeholder="Buscar por nome..."
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Score M√≠nimo (%)</label>
                    <input type="number" id="searchScore" placeholder="Ex: 70" min="0" max="100"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ordenar por</label>
                    <select id="sortBy" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="score">Maior Score</option>
                        <option value="position">Melhor Posi√ß√£o</option>
                        <option value="name">Nome (A-Z)</option>
                    </select>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="aplicarFiltros()" 
                        class="bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 flex items-center gap-2">
                    <span>üîç</span>
                    Aplicar Filtros
                </button>
                <button onclick="limparFiltros()" 
                        class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 flex items-center gap-2">
                    <span>üßπ</span>
                    Limpar
                </button>
                <button onclick="toggleFavoritosOnly()" id="favoritosBtn"
                        class="bg-yellow-100 hover:bg-yellow-200 text-yellow-700 px-6 py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 flex items-center gap-2">
                    <span>‚≠ê</span>
                    S√≥ Favoritos
                </button>
            </div>
        </div>

    <!-- Lista de Candidatos -->
        <div id="candidatosList">
            {% if candidatos %}
            <div class="mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                    <span>üë•</span>
                    Lista de Candidatos
                </h3>
                <p class="text-gray-600">Total: <span id="totalCandidatos">{{ candidatos|length }}</span> candidato(s)</p>
            </div>

            <div class="grid gap-6" id="candidatosGrid">
                {% for candidato in candidatos %}
                <div class="candidato-card group bg-white rounded-2xl p-6 shadow-sm border border-gray-100 hover:shadow-xl hover:border-blue-200 transition-all duration-300 transform hover:-translate-y-1"
                     data-nome="{{ candidato[0].lower() }}"
                     data-score="{{ candidato[4] }}"
                     data-posicao="{{ candidato[5] }}"
                     data-candidato-id="{{ candidato[6] }}"
                     data-favorited="false">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-6">
                        <div class="flex-1">
                            <div class="flex items-start gap-4">
                                <div class="w-16 h-16 bg-gradient-to-br from-blue-100 to-purple-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <span class="text-2xl">üë§</span>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-3">
                                        <h3 class="text-xl font-bold text-gray-800 group-hover:text-blue-600 transition-colors">
                                            {{ candidato[0] }}
                                        </h3>
                                        <span class="favorito-badge bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-medium hidden">
                                            ‚≠ê Favorito
                                        </span>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-gray-600">
                                        <div class="flex items-center gap-2">
                                            <span>üìß</span>
                                            <span>{{ candidato[1] }}</span>
                                        </div>
                                        {% if candidato[2] %}
                                        <div class="flex items-center gap-2">
                                            <span>üì±</span>
                                            <span>{{ candidato[2] }}</span>
                                        </div>
                                        {% endif %}
                                        {% if candidato[7] and candidato[7].strip() %}
                                        <div class="flex items-center gap-2">
                                            <span>üìç</span>
                                            <span>{{ candidato[7] }}</span>
                                        </div>
                                        {% endif %}
                                        {% if candidato[3] %}
                                        <div class="flex items-center gap-2">
                                            <span>üîó</span>
                                            <a href="{{ candidato[3] }}" target="_blank" 
                                               class="text-blue-600 hover:text-blue-800 transition-colors">
                                                LinkedIn
                                            </a>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-col items-center gap-4 lg:w-48">
                            <div class="flex gap-3">
                                <div class="text-center bg-gradient-to-r from-blue-500 to-purple-500 text-white px-4 py-3 rounded-xl shadow-md">
                                    <div class="text-lg font-bold">{{ candidato[5] }}¬∫</div>
                                    <div class="text-xs opacity-90">posi√ß√£o</div>
                                </div>
                                <div class="text-center bg-gradient-to-r from-green-500 to-emerald-500 text-white px-4 py-3 rounded-xl shadow-md cursor-pointer hover:bg-gradient-to-r hover:from-green-600 hover:to-emerald-600 transition-all"
                                     onclick="mostrarDetalhesScore({{ candidato[6] }}, '{{ candidato[0] }}', {{ candidato[4] }})">
                                    <div class="text-lg font-bold">{{ "%.0f"|format(candidato[4]) }}%</div>
                                    <div class="text-xs opacity-90">ver detalhes</div>
                                </div>
                            </div>

                            <div class="flex gap-2">
                                <button onclick="toggleFavoriteCandidato({{ candidato[6] }}, {{ vaga_id }}, this)"
                                        class="favorite-candidato-btn bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 flex items-center gap-2"
                                        data-candidato-id="{{ candidato[6] }}"
                                        data-favorited="false">
                                    <span class="favorite-icon">‚≠ê</span>
                                    <span class="favorite-text">Favoritar</span>
                                </button>
                                <a href="{{ url_for('baixar_curriculo', candidato_id=candidato[6]) }}"
                                   class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 flex items-center gap-2">
                                    <span>üìÑ</span>
                                    CV
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12 bg-white rounded-2xl shadow-sm border border-gray-100">
                <div class="w-24 h-24 bg-gray-100 rounded-full mx-auto mb-6 flex items-center justify-center">
                    <span class="text-4xl">üë•</span>
                </div>
                <h3 class="text-xl font-bold text-gray-600 mb-3">Nenhum candidato ainda</h3>
                <p class="text-gray-500">Aguarde candidatos se inscreverem nesta vaga.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Vari√°veis globais
let candidatosOriginais = [];
let candidatosFiltrados = [];
let mostrarSoFavoritos = false;

// Inicializar dados dos candidatos
document.addEventListener('DOMContentLoaded', function() {
    candidatosOriginais = Array.from(document.querySelectorAll('.candidato-card')).map(card => {
        return {
            element: card,
            nome: card.dataset.nome,
            score: parseFloat(card.dataset.score),
            posicao: parseInt(card.dataset.posicao),
            candidatoId: card.dataset.candidatoId,
            favorited: card.dataset.favorited === 'true'
        };
    });

    candidatosFiltrados = [...candidatosOriginais];
    loadFavoriteStatus();
});

// Carregar status dos favoritos
async function loadFavoriteStatus() {
    try {
        const response = await fetch('/api/candidatos-favoritos');
        const favoritos = await response.json();

        const favoritosMap = new Map();
        favoritos.forEach(fav => {
            favoritosMap.set(`${fav.id}_${fav.vaga_id}`, true);
        });

        candidatosOriginais.forEach(candidato => {
            const key = `${candidato.candidatoId}_{{ vaga_id }}`;
            if (favoritosMap.has(key)) {
                candidato.favorited = true;
                candidato.element.dataset.favorited = 'true';

                const button = candidato.element.querySelector('.favorite-candidato-btn');
                const badge = candidato.element.querySelector('.favorito-badge');

                updateFavoriteButton(button, true);
                badge.classList.remove('hidden');
            }
        });
    } catch (error) {
        console.error('Erro ao carregar favoritos:', error);
    }
}

// Aplicar filtros
function aplicarFiltros() {
    const searchName = document.getElementById('searchName').value.toLowerCase();
    const searchScore = document.getElementById('searchScore').value;
    const sortBy = document.getElementById('sortBy').value;

    candidatosFiltrados = candidatosOriginais.filter(candidato => {
        const matchName = !searchName || candidato.nome.includes(searchName);
        const matchScore = !searchScore || candidato.score >= parseFloat(searchScore);
        const matchFavoritos = !mostrarSoFavoritos || candidato.favorited;

        return matchName && matchScore && matchFavoritos;
    });

    // Ordenar resultados
    switch(sortBy) {
        case 'score':
            candidatosFiltrados.sort((a, b) => b.score - a.score);
            break;
        case 'position':
            candidatosFiltrados.sort((a, b) => a.posicao - b.posicao);
            break;
        case 'name':
            candidatosFiltrados.sort((a, b) => a.nome.localeCompare(b.nome));
            break;
    }

    renderCandidatos();
}

// Renderizar candidatos filtrados
function renderCandidatos() {
    const grid = document.getElementById('candidatosGrid');
    const totalElement = document.getElementById('totalCandidatos');

    // Esconder todos os candidatos
    candidatosOriginais.forEach(candidato => {
        candidato.element.style.display = 'none';
    });

    // Mostrar apenas os filtrados
    candidatosFiltrados.forEach(candidato => {
        candidato.element.style.display = 'block';
        grid.appendChild(candidato.element);
    });

    // Atualizar contador
    totalElement.textContent = candidatosFiltrados.length;

    // Mostrar mensagem se vazio
    if (candidatosFiltrados.length === 0) {
        grid.innerHTML = `
            <div class="col-span-full text-center py-12 bg-white rounded-2xl shadow-sm border border-gray-100">
                <div class="w-24 h-24 bg-gray-100 rounded-full mx-auto mb-6 flex items-center justify-center">
                    <span class="text-4xl">üîç</span>
                </div>
                <h3 class="text-xl font-bold text-gray-600 mb-3">Nenhum resultado encontrado</h3>
                <p class="text-gray-500">Tente ajustar os filtros de busca.</p>
            </div>
        `;
    }
}

// Limpar filtros
function limparFiltros() {
    document.getElementById('searchName').value = '';
    document.getElementById('searchScore').value = '';
    document.getElementById('sortBy').value = 'score';
    mostrarSoFavoritos = false;

    const favoritosBtn = document.getElementById('favoritosBtn');
    favoritosBtn.classList.remove('bg-yellow-500', 'text-white');
    favoritosBtn.classList.add('bg-yellow-100', 'text-yellow-700');

    candidatosFiltrados = [...candidatosOriginais];
    renderCandidatos();
}

// Toggle filtro de favoritos
function toggleFavoritosOnly() {
    mostrarSoFavoritos = !mostrarSoFavoritos;
    const btn = document.getElementById('favoritosBtn');

    if (mostrarSoFavoritos) {
        btn.classList.remove('bg-yellow-100', 'text-yellow-700');
        btn.classList.add('bg-yellow-500', 'text-white');
        btn.innerHTML = '<span>‚≠ê</span> Mostrando Favoritos';
    } else {
        btn.classList.remove('bg-yellow-500', 'text-white');
        btn.classList.add('bg-yellow-100', 'text-yellow-700');
        btn.innerHTML = '<span>‚≠ê</span> S√≥ Favoritos';
    }

    aplicarFiltros();
}

// Toggle favorito candidato
async function toggleFavoriteCandidato(candidatoId, vagaId, button) {
    const isFavorited = button.dataset.favorited === 'true';

    try {
        button.classList.add('opacity-50', 'pointer-events-none');

        const response = await fetch('/api/favoritar-candidato', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                candidato_id: candidatoId,
                vaga_id: vagaId,
                acao: 'toggle'
            })
        });

        const result = await response.json();

        if (result.success) {
            // Atualizar dados locais
            const candidato = candidatosOriginais.find(c => c.candidatoId == candidatoId);
            if (candidato) {
                candidato.favorited = result.favorited;
                candidato.element.dataset.favorited = result.favorited;

                const badge = candidato.element.querySelector('.favorito-badge');
                if (result.favorited) {
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }

            updateFavoriteButton(button, result.favorited);
            showToast(result.message, 'success');
        } else {
            showToast(result.message || 'Erro ao favoritar candidato', 'error');
        }
    } catch (error) {
        console.error('Erro ao favoritar candidato:', error);
        showToast('Erro ao favoritar candidato', 'error');
    } finally {
        button.classList.remove('opacity-50', 'pointer-events-none');
    }
}

// Atualizar bot√£o de favorito
function updateFavoriteButton(button, isFavorited) {
    button.dataset.favorited = isFavorited;
    const icon = button.querySelector('.favorite-icon');
    const text = button.querySelector('.favorite-text');

    if (isFavorited) {
        button.className = 'favorite-candidato-btn bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 flex items-center gap-2';
        icon.textContent = '‚ù§Ô∏è';
        text.textContent = 'Favoritado';
    } else {
        button.className = 'favorite-candidato-btn bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 flex items-center gap-2';
        icon.textContent = '‚≠ê';
        text.textContent = 'Favoritar';
    }
}

// Toast notifications
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 z-50 px-6 py-4 rounded-xl shadow-lg transform translate-y-full transition-all duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    toast.textContent = message;

    document.body.appendChild(toast);

    // Animar entrada
    setTimeout(() => {
        toast.classList.remove('translate-y-full');
    }, 100);

    // Remover ap√≥s 3 segundos
    setTimeout(() => {
        toast.classList.add('translate-y-full');
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}
</script>

<!-- Modal de Detalhes do Score -->
<div id="modalScore" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                <span>üìä</span> Detalhes do Score
            </h3>
            <button onclick="fecharModalScore()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
        </div>
        
        <div id="conteudoScore" class="space-y-4">
            <!-- Conte√∫do ser√° preenchido via JavaScript -->
        </div>
        
        <div class="mt-6 flex justify-end">
            <button onclick="fecharModalScore()" 
                    class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                Fechar
            </button>
        </div>
    </div>
</div>

<script>
async function mostrarDetalhesScore(candidatoId, candidatoNome, scoreTotal) {
    try {
        // Buscar detalhes do score via API
        const response = await fetch(`/api/score-detalhes/${candidatoId}/{{ vaga_id }}`);
        const detalhes = await response.json();
        
        if (detalhes.error) {
            showToast('Erro ao carregar detalhes do score', 'error');
            return;
        }
        
        // Preencher o modal
        const conteudo = document.getElementById('conteudoScore');
        conteudo.innerHTML = `
            <div class="text-center mb-6">
                <h4 class="text-xl font-bold text-gray-800 mb-2">${candidatoNome}</h4>
                <div class="text-3xl font-bold text-green-600">${Math.round(scoreTotal)}% de Match</div>
            </div>
            
            <div class="space-y-4">
                <div class="bg-purple-50 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h5 class="font-semibold text-purple-800">üí∞ Compatibilidade Salarial</h5>
                        <span class="text-purple-600 font-bold">${detalhes.salarial || 0}pts (20%)</span>
                    </div>
                    <p class="text-sm text-gray-600">${detalhes.explicacao_salarial || 'An√°lise da pretens√£o vs. sal√°rio oferecido'}</p>
                </div>
                
                <div class="bg-blue-50 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h5 class="font-semibold text-blue-800">‚ö° Requisitos T√©cnicos</h5>
                        <span class="text-blue-600 font-bold">${detalhes.requisitos || 0}pts (40%)</span>
                    </div>
                    <p class="text-sm text-gray-600">${detalhes.explicacao_requisitos || 'Compatibilidade com tecnologias e habilidades'}</p>
                </div>
                
                <div class="bg-green-50 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h5 class="font-semibold text-green-800">üéì Experi√™ncia</h5>
                        <span class="text-green-600 font-bold">${detalhes.experiencia || 0}pts (15%)</span>
                    </div>
                    <p class="text-sm text-gray-600">${detalhes.explicacao_experiencia || 'N√≠vel de senioridade identificado'}</p>
                </div>
                
                <div class="bg-yellow-50 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h5 class="font-semibold text-yellow-800">‚≠ê Diferenciais</h5>
                        <span class="text-yellow-600 font-bold">${detalhes.diferenciais || 0}pts (10%)</span>
                    </div>
                    <p class="text-sm text-gray-600">${detalhes.explicacao_diferenciais || 'Certifica√ß√µes e habilidades extras'}</p>
                </div>
                
                <div class="bg-orange-50 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h5 class="font-semibold text-orange-800">üìç Localiza√ß√£o</h5>
                        <span class="text-orange-600 font-bold">${detalhes.localizacao || 0}pts (10%)</span>
                    </div>
                    <p class="text-sm text-gray-600">${detalhes.explicacao_localizacao || 'Proximidade geogr√°fica'}</p>
                </div>
                
                <div class="bg-indigo-50 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h5 class="font-semibold text-indigo-800">üéì Forma√ß√£o</h5>
                        <span class="text-indigo-600 font-bold">${detalhes.formacao || 0}pts (5%)</span>
                    </div>
                    <p class="text-sm text-gray-600">${detalhes.explicacao_formacao || 'N√≠vel educacional'}</p>
                </div>
            </div>
        `;
        
        // Mostrar modal
        document.getElementById('modalScore').classList.remove('hidden');
        
    } catch (error) {
        console.error('Erro ao carregar detalhes do score:', error);
        showToast('Erro ao carregar detalhes do score', 'error');
    }
}

function fecharModalScore() {
    document.getElementById('modalScore').classList.add('hidden');
}
</script>

<!-- Incluir o modal de encerramento -->
{% include 'partials/modal_encerramento.html' %}

{% endblock %}